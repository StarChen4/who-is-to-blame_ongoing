# 数据字段映射表

本文档详细说明如何从OpenDota和ProTracker获取分析所需的数据。

## OpenDota数据映射

### 概览页 (Overview Tab)

**URL格式**: `https://www.opendota.com/matches/{match_id}/overview`

| 方法论指标 | 页面位置 | 获取方式 | 示例值 |
|-----------|---------|---------|-------|
| 比赛胜负 | 页面顶部banner | 查找"天辉胜利"或"夜魇胜利"文本 | "夜魇胜利" |
| 英雄名称 | 玩家表格 | 提取英雄图标alt文本或相邻文本 | "Tidehunter", "Dazzle" |
| 玩家昵称 | 玩家表格 | 玩家链接文本 | "Ander", "ssdsdbcx" |
| KDA | 玩家表格 | "击杀/死亡/助攻"列 | "7/10/9" |
| 正补/反补 | 玩家表格 | "正补/反补"列 | "197/1" |
| NET | 玩家表格 | "NET"列 | "12.1k" |
| GPM/XPM | 玩家表格 | "GPM/XPM"列 | "361/490" |
| 英雄伤害 | 玩家表格 | "英雄伤害"列 | "13.5k" |
| 防御塔伤害 | 玩家表格 | "防御塔伤害"列 | "856" |
| 英雄治疗 | 玩家表格 | "英雄治疗"列 | "13.5k" |
| 选人顺序 | BP区域 | 查找"选择 X"或"禁止 X"文本 | "选择 3" |

**注意**:
- 数值可能包含"k"后缀,需要转换(1k=1000)
- "-"表示无数据或0
- 需要区分天辉和夜魇两队

### 表现页 (Performances Tab)

**URL格式**: `https://www.opendota.com/matches/{match_id}/performances`

| 方法论指标 | 页面位置 | 获取方式 | 示例值 |
|-----------|---------|---------|-------|
| 连杀记录 | 表现表格 | "连杀记录"列 | "3", "9" |
| 控制时间 | 表现表格 | "控制时间"列(秒) | "28.40", "18.50" |
| 拉野次数 | 表现表格 | "拉野"列 | "1", "2" |
| 死亡时长 | 表现表格 | "死亡"列(分:秒) | "4:03", "6:25" |
| 买活次数 | 表现表格 | "买活"列 | "1", "2" |
| 发信号次数 | 表现表格 | "发信号"列 | "5", "10" |
| 最高单次伤害 | 表现表格 | "最高单次伤害"列 | "259", "742" |

**注意**:
- 控制时间单位是秒
- 死亡时长格式为"分:秒",需要转换为秒
- "-"表示0或无数据

### 分路页 (Laning Tab)

**URL格式**: `https://www.opendota.com/matches/{match_id}/laning`

| 方法论指标 | 页面位置 | 获取方式 | 示例值 |
|-----------|---------|---------|-------|
| 分路位置 | 分路表格 | "分路"列 | "优势路", "中路", "劣势路" |
| 对线胜率 | 分路表格 | "WIN"列(百分比) | "53.33%", "72.64%" |
| 前10分钟正补 | 分路表格 | "前10分钟正补"列 | "16", "52" |
| 前10分钟反补 | 分路表格 | "前10分钟反补"列 | "5", "16" |

**位置映射规则**:
- 优势路 + 高正补(>30) → 1号位
- 中路 → 2号位
- 劣势路 + 高正补(>20) → 3号位
- 优势路 + 低正补(<15) → 4号位
- 劣势路 + 低正补(<10) → 5号位

**注意**:
- 有时同一条路有2个人,需要根据正补数量区分
- 百分比需要去除"%"符号转换为数字

### 团战页 (Teamfights Tab)

**URL格式**: `https://www.opendota.com/matches/{match_id}/teamfights`

| 方法论指标 | 页面位置 | 获取方式 | 示例值 |
|-----------|---------|---------|-------|
| 团战伤害 | 团战表格 | "伤害"列 | "157", "965" |
| 团战治疗 | 团战表格 | "治疗"列 | "187", "0" |
| 团战死亡 | 团战表格 | 是否有死亡图标 | true/false |

**计算参团率**:
```
参团率 = (玩家击杀 + 玩家助攻) / 全队总击杀数
```

**注意**:
- 这里显示的是单场团战的数据,需要遍历所有团战
- 死亡用图标表示,需要检测是否存在死亡图标

### 曲线图页 (Graphs Tab)

**URL格式**: `https://www.opendota.com/matches/{match_id}/graphs`

| 方法论指标 | 页面位置 | 获取方式 | 示例值 |
|-----------|---------|---------|-------|
| 经济曲线 | 图表数据 | 提取时间轴和净值差异 | 见下方说明 |

**经济背景判定**:
- 如果全队经济落后>5000: 经济劣势期
- 如果全队经济领先>5000: 经济优势期
- 其他: 均势期

**注意**:
- 曲线图可能是SVG或Canvas,需要从页面数据中提取
- 也可以通过概览页的净值对比推断

## ProTracker克制数据

### 英雄克制页面

**URL格式**: `https://dota2protracker.com/hero/{hero_name}`

英雄名称需要转换为URL友好格式:
- 空格转为"-"
- 全小写
- 例如: "Bounty Hunter" → "bounty-hunter"

### 克制关系提取

**Countered By(被克制)**:

在页面中查找"Countered By"或"Counter Picks"区域,提取:

| 数据 | 位置 | 获取方式 | 示例值 |
|-----|------|---------|-------|
| 克制英雄名称 | 克制列表 | 英雄名称或图标 | "Zeus", "Anti-Mage" |
| 对抗胜率 | 胜率数据 | 显示的胜率百分比 | "38.5%", "41.2%" |

**Good Against(克制)**:

在页面中查找"Good Against"区域,提取:

| 数据 | 位置 | 获取方式 | 示例值 |
|-----|------|---------|-------|
| 被克制英雄名称 | 克制列表 | 英雄名称或图标 | "Meepo", "Broodmother" |
| 对抗胜率 | 胜率数据 | 显示的胜率百分比 | "56.8%", "59.3%" |

**克制判定阈值**:
- 胜率 < 43%: 被严重克制
- 胜率 43-47%: 被轻度克制
- 胜率 47-53%: 均势
- 胜率 53-57%: 轻度克制
- 胜率 > 57%: 严重克制

**注意**:
- ProTracker数据基于职业比赛,相对稳定
- 可以缓存到 `/d/projects/who-is-to-blame/data/cache/{hero_name}.json`
- 缓存有效期可设为1周

## 数据质量检查

### 必需数据

分析必须要有以下数据:
- ✅ 比赛胜负
- ✅ 英雄名称
- ✅ KDA
- ✅ GPM/XPM
- ✅ 分路位置

### 可选数据

以下数据缺失时可降级处理:
- ⚠️ 克制关系(无法调整克制系数)
- ⚠️ 团战数据(无法计算参团率)
- ⚠️ 前10分数据(无法分析对线)

### 数据异常处理

| 异常情况 | 处理方式 |
|---------|---------|
| 比赛未分析 | 提示用户等待或手动触发分析 |
| 部分玩家数据缺失 | 跳过该玩家或使用默认值 |
| ProTracker无法访问 | 跳过克制系数调整 |
| 分路数据不清晰 | 使用GPM排序推断位置 |

## 数据示例

### 完整数据结构示例

```json
{
  "match_id": "8669004890",
  "winner": "夜魇",
  "loser": "天辉",
  "radiant_team": [
    {
      "player_name": "Ander",
      "hero": "Tidehunter",
      "position": 3,
      "lane": "劣势路",
      "kills": 7,
      "deaths": 10,
      "assists": 9,
      "last_hits": 197,
      "denies": 1,
      "net_worth": 12100,
      "gpm": 361,
      "xpm": 490,
      "hero_damage": 13500,
      "tower_damage": 0,
      "hero_healing": 13500,
      "stun_duration": 28.4,
      "camps_stacked": 1,
      "lane_win_rate": 45.65,
      "lane_last_hits_10min": 29,
      "lane_denies_10min": 1,
      "teamfight_participation": 0.73,
      "countered_by": ["Underlord", "Razor"],
      "counters": ["Bounty Hunter"]
    }
  ]
}
```

## 获取顺序建议

为了优化性能和用户体验,建议按以下顺序获取数据:

1. **概览页** (必需) - 判断胜负、获取基础数据
2. **分路页** (必需) - 确定位置、获取对线数据
3. **表现页** (重要) - 获取辅助数据
4. **团战页** (重要) - 获取团战数据
5. **曲线图页** (可选) - 获取经济曲线
6. **ProTracker** (并发) - 获取5个英雄的克制数据(可并发请求)

总耗时估计: 15-30秒(取决于网络和是否需要触发分析)
