# 数据字段映射表

本文档详细说明如何从OpenDota和ProTracker获取分析所需的数据。

## OpenDota数据映射

### 概览页 (Overview Tab)

**URL格式**: `https://www.opendota.com/matches/{match_id}/overview`

| 方法论指标 | 页面位置 | 获取方式 | 示例值 |
|-----------|---------|---------|-------|
| 比赛胜负 | 页面顶部banner | 查找"天辉胜利"或"夜魇胜利"文本 | "夜魇胜利" |
| 英雄名称 | 玩家表格 | 提取英雄图标alt文本 | "Tidehunter", "Dazzle" |
| 玩家昵称 | 玩家表格 | 玩家链接文本 | "Ander", "ssdsdbcx" |
| KDA | 玩家表格 | "击杀/死亡/助攻"列 | "7/10/9" |
| 正补/反补 | 玩家表格 | "正补/反补"列 | "197/1" |
| NET | 玩家表格 | "NET"列 | "12.1k" |
| GPM/XPM | 玩家表格 | "GPM/XPM"列 | "361/490" |
| 英雄伤害 | 玩家表格 | "英雄伤害"列 | "13.5k" |
| 防御塔伤害 | 玩家表格 | "防御塔伤害"列 | "856" |
| 英雄治疗 | 玩家表格 | "英雄治疗"列 | "13.5k" |
| 选人顺序 | BP区域 | 查找"选择 X"或"禁止 X"文本 | "选择 3" |

**注意**:
- 数值可能包含"k"后缀,需要转换(1k=1000)
- "-"表示无数据或0
- 需要区分天辉和夜魇两队
- 获取到概览页信息后，向玩家输出比赛的英雄、昵称和选人顺序，但不要中断分析

### 表现页 (Performances Tab)

**URL格式**: `https://www.opendota.com/matches/{match_id}/performances`

| 方法论指标 | 页面位置 | 获取方式 | 示例值 |
|-----------|---------|---------|-------|
| 连杀记录 | 表现表格 | "连杀记录"列 | "3", "9" |
| 控制时间 | 表现表格 | "控制时间"列(秒) | "28.40", "18.50" |
| 拉野次数 | 表现表格 | "拉野"列 | "1", "2" |
| 死亡时长 | 表现表格 | "死亡"列(分:秒) | "4:03", "6:25" |
| 买活次数 | 表现表格 | "买活"列 | "1", "2" |
| 发信号次数 | 表现表格 | "发信号"列 | "5", "10" |
| 最高单次伤害 | 表现表格 | "最高单次伤害"列 | "259", "742" |

**注意**:
- 控制时间单位是秒
- 死亡时长格式为"分:秒",需要转换为秒
- "-"表示0或无数据

### 分路页 (Laning Tab)

**URL格式**: `https://www.opendota.com/matches/{match_id}/laning`

| 方法论指标 | 页面位置 | 获取方式 | 示例值 |
|-----------|---------|---------|-------|
| 分路位置 | 分路表格 | "分路"列 | "优势路", "中路", "劣势路" |
| 对线胜率 | 分路表格 | "WIN"列(百分比) | "53.33%", "72.64%" |
| 前10分钟正补 | 分路表格 | "前10分钟正补"列 | "16", "52" |
| 前10分钟反补 | 分路表格 | "前10分钟反补"列 | "5", "16" |

**位置映射规则**:
- 优势路 + 高正补(>30) → 1号位
- 中路 → 2号位
- 劣势路 + 高正补(>20) → 3号位
- 优势路 + 低正补(<15) → 4号位
- 劣势路 + 低正补(<10) → 5号位
- 正补数量在被压制很惨时不会特别高，所以判断边界不能过于严格

**注意**:
- 一般同一条路有2个人,需要根据正补数量区分
- 百分比需要去除"%"符号转换为数字

### 团战页 (Teamfights Tab)

**URL格式**: `https://www.opendota.com/matches/{match_id}/teamfights`

| 方法论指标 | 页面位置 | 获取方式 | 示例值 |
|-----------|---------|---------|-------|
| 团战伤害 | 团战表格 | "伤害"列 | "157", "965" |
| 团战治疗 | 团战表格 | "治疗"列 | "187", "0" |
| 团战死亡 | 团战表格 | 是否有死亡图标 | true/false |

**计算参团率**:
```
参团率 = (玩家击杀 + 玩家助攻) / 全队总击杀数
```

**注意**:
- 这里显示的是单场团战的数据,需要遍历所有团战
- 死亡用图标表示,需要检测是否存在死亡图标

### 曲线图页 (Graphs Tab)

**URL格式**: `https://www.opendota.com/matches/{match_id}/graphs`

| 方法论指标 | 页面位置 | 获取方式 | 示例值 |
|-----------|---------|---------|-------|
| 经济曲线 | 图表数据 | 提取时间轴和净值差异 | 见下方说明 |

**经济背景判定**:
- 如果全队经济落后>5000: 经济劣势期
- 如果全队经济领先>5000: 经济优势期
- 其他: 均势期

**注意**:
- 曲线图可能是SVG或Canvas,需要从页面数据中提取
- 也可以通过概览页的净值对比推断

### 视野页 (Vision Tab)

**URL格式**: `https://www.opendota.com/matches/{match_id}/vision`

**适用范围**: 仅用于评估4/5号位辅助的视野责任

| 方法论指标 | 页面位置 | 获取方式 | 示例值 |
|-----------|---------|---------|-------|
| 侦查守卫购买 | 购买表格 | "Observer Ward"列 | "5", "3" |
| 侦查守卫使用 | 眼位记录 | 统计该玩家侦查守卫放置数量 | "4", "2" |
| 岗哨守卫购买 | 购买表格 | "Sentry Ward"列 | "8", "4" |
| 岗哨守卫使用 | 眼位记录 | 统计该玩家岗哨守卫放置数量 | "6", "3" |
| 显影之尘购买 | 购买表格 | "Dust of Appearance"列 | "2", "0" |
| 诡计之雾购买 | 购买表格 | "Smoke of Deceit"列 | "3", "1" |
| 守卫平均存活时长 | 眼位记录 | 计算该玩家所有侦查守卫的平均存活秒数 | "85.5", "42.3" |

**页面数据结构说明**:
- **全部时间区域**: 各玩家视野物品使用图标汇总
- **购买区域**: 各玩家购买的守卫/粉/雾数量表格
- **放眼时间轴**: 天辉/夜魇各自的放眼时间轴图
- **眼位记录表格**: 详细记录每个眼位的玩家、放置时间、存活时间、是否被反

**注意**:
- 此数据仅用于4/5号位的视野责任评估
- 1/2/3号位的视野数据忽略不计,不参与畜度计算
- 守卫存活时长需要从眼位记录中计算平均值
- "-"或空值表示0
- **重要**: 需要同时获取双方辅助(4/5号位)的视野数据用于对比

**双方辅助对比说明**:
- 获取我方(输方)4/5号位的视野数据
- 获取对方(赢方)4/5号位的视野数据
- 对比重点是**态度**(购买/使用数量),而非能力(存活时长)
- 因为劣势方被视野压制导致存活时长较低是正常的

## 选人顺序数据（STRATZ）

### 选人阶段页面

**URL格式**: `https://stratz.com/matches/{match_id}`

**页面位置**: 页面中部"阵容"区域，按选择阶段分组显示

| 数据项 | 页面位置 | 获取方式 | 示例值 |
|-------|---------|---------|-------|
| 选择阶段1英雄 | "阵容"→"选择阶段1" | 提取该区域的英雄图标 | "戴泽", "潮汐猎人" |
| 选择阶段2英雄 | "阵容"→"选择阶段2" | 提取该区域的英雄图标 | "凯", "莉娜" |
| 选择阶段3英雄 | "阵容"→"选择阶段3" | 提取该区域的英雄图标 | "巫医", "斧王" |

### DOTA2选人机制说明

```
第一轮(阶段1): 1-4手同时选（每方2个，互相看不到）
第二轮(阶段2): 5-8手同时选（每方2个，能看到前一轮）
第三轮(阶段3): 9-10手同时选（每方1个，能看到前两轮）
```

### 阶段映射规则

```python
选择阶段映射 = {
    "阶段1": [1, 2, 3, 4],   # 1-4手同时盲选
    "阶段2": [5, 6, 7, 8],   # 5-8手同时，能看到阶段1
    "阶段3": [9, 10]         # 9-10手同时，能看到阶段1-2
}

# 选人顺序分组
选人顺序分组 = {
    "早期盲选": [1, 2, 3, 4],  # 双方同时，互相看不到
    "中期选人": [5, 6, 7, 8],  # 能看到1-4手，双方同时
    "后期补选": [9, 10]        # 能看到1-8手，双方同时
}
```

### 数据结构示例

```json
{
  "draft_data": {
    "radiant": {
      "phase1": ["Dazzle", "Tidehunter"],
      "phase2": ["Void Spirit", "Lina"],
      "phase3": ["Witch Doctor"]
    },
    "dire": {
      "phase1": ["Bounty Hunter", "Razor"],
      "phase2": ["Warlock", "Underlord"],
      "phase3": ["Axe"]
    }
  },
  "player_picks": [
    {
      "player_name": "ssdsdbcx",
      "hero": "Dazzle",
      "position": 2,
      "pick_phase": 1,
      "pick_order_range": [1, 2, 3, 4]
    }
  ]
}
```

### 注意事项

- STRATZ按选择阶段分组显示，数据完整可靠
- 同一阶段内的英雄无法区分具体选择顺序（因为是同时选的）
- 需要将英雄与玩家/位置关系进行匹配
- 用于判断选人责任时，仅评估1/2/3号位核心

## 克制关系数据

### 英雄克制页面

**URL格式**: `https://dota2.tools/tools/hero-counter-viewer`

### 获取步骤

1. 打开克制查看器页面
2. 在英雄列表中点击目标英雄按钮（如 `button "Medusa Medusa"`），或在搜索栏中直接搜索英雄名称
3. 页面会自动显示该英雄的克制数据

### 克制关系提取

**HEROES COUNTERING HIM(被克制)**:

在页面 `heading "HEROES COUNTERING HIM"` 区域下提取:

| 数据 | 获取方式 | 示例值 |
|-----|---------|-------|
| 克制英雄名称 | 英雄图片旁的文本 | "Elder Titan", "Anti-Mage" |
| 对局胜率 | "对局胜率"后的数值 | "44.8%", "49.5%" |
| 克制指数 | "克制指数"后的数值 | "-4.83%", "-2.68%" |

**HEROES HE COUNTERS(克制)**:

在页面 `heading "HEROES HE COUNTERS"` 区域下提取:

| 数据 | 获取方式 | 示例值 |
|-----|---------|-------|
| 被克制英雄名称 | 英雄图片旁的文本 | "Bloodseeker", "Ancient Apparition" |
| 对局胜率 | "对局胜率"后的数值 | "51.3%", "53.1%" |
| 克制指数 | "克制指数"后的数值 | "+0.16%", "+1.59%" |

**ITEMS COUNTERING HIM(克制装备)**:

在页面 `heading "ITEMS COUNTERING HIM"` 区域下提取:

| 数据 | 获取方式 | 示例值 |
|-----|---------|-------|
| 装备名称 | 装备图片旁的文本 | "Diffusal Blade", "Disperser" |
| 有效程度 | "High"/"Medium"/"Low" | "High" |

**克制判定阈值**(基于克制指数):
- 克制指数 < -4%: 被严重克制
- 克制指数 -4% ~ -2%: 被轻度克制
- 克制指数 -2% ~ +2%: 均势
- 克制指数 +2% ~ +4%: 轻度克制
- 克制指数 > +4%: 严重克制

**注意**:
- Dota2.Tools数据基于全局统计,相对稳定
- 页面同时提供克制原因说明,可用于报告生成
- 建议批量获取5个英雄的克制数据后再进行分析

## 数据质量检查

### 必需数据

分析必须要有以下数据:
- ✅ 比赛胜负
- ✅ 英雄名称
- ✅ KDA
- ✅ GPM/XPM
- ✅ 分路位置

### 可选数据

以下数据缺失时可降级处理:
- ⚠️ 克制关系(无法调整克制系数)
- ⚠️ 团战数据(无法计算参团率)
- ⚠️ 前10分数据(无法分析对线)

### 数据异常处理

| 异常情况 | 处理方式 |
|---------|---------|
| 比赛未分析 | 提示用户等待或手动触发分析 |
| 部分玩家数据缺失 | 跳过该玩家或使用默认值 |
| ProTracker无法访问 | 跳过克制系数调整 |
| 分路数据不清晰 | 使用GPM排序推断位置 |

## 数据示例

### 完整数据结构示例

```json
{
  "match_id": "8669004890",
  "winner": "夜魇",
  "loser": "天辉",
  "radiant_team": [
    {
      "player_name": "Ander",
      "hero": "Tidehunter",
      "position": 3,
      "lane": "劣势路",
      "kills": 7,
      "deaths": 10,
      "assists": 9,
      "last_hits": 197,
      "denies": 1,
      "net_worth": 12100,
      "gpm": 361,
      "xpm": 490,
      "hero_damage": 13500,
      "tower_damage": 0,
      "hero_healing": 13500,
      "stun_duration": 28.4,
      "camps_stacked": 1,
      "lane_win_rate": 45.65,
      "lane_last_hits_10min": 29,
      "lane_denies_10min": 1,
      "teamfight_participation": 0.73,
      "countered_by": ["Underlord", "Razor"],
      "counters": ["Bounty Hunter"]
    }
  ]
}
```

## 获取顺序建议

为了优化性能和用户体验,建议按以下顺序获取数据:

1. **概览页** (必需) - 判断胜负、获取基础数据
2. **分路页** (必需) - 确定位置、获取对线数据
3. **表现页** (重要) - 获取辅助数据
4. **团战页** (重要) - 获取团战数据
5. **视野页** (重要) - 获取4/5号位的视野数据
6. **曲线图页** (可选) - 获取经济曲线
7. **Dota2.Tools** (并发) - 获取5个英雄的克制数据(可并发请求)

总耗时估计: 20-40秒(取决于网络和是否需要触发分析)

## STRATZ数据获取

在获取OpenDota数据的同时（或之后），需要从STRATZ获取选人顺序数据：

8. **STRATZ选人数据** (重要) - 获取选人阶段信息，用于选人责任判定

### 获取步骤

1. 访问 `https://stratz.com/matches/{match_id}`
2. 定位页面中部"阵容"区域
3. 提取三个选择阶段的英雄分组
4. 将英雄与已获取的玩家/位置数据进行匹配
5. 生成玩家选人阶段映射表
